/*! marvin 2016-04-12 */
"use strict";var Galaxy,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Galaxy=function(){function a(b){return!1==this instanceof a?new a:void this.init(b)}return marvin.Galaxy=a,a.prototype.init=function(a){this.setPlateIfu(a),this.maindiv=$("#"+this.plateifu),this.mapdiv=this.maindiv.find("#map"),this.specdiv=this.maindiv.find("#graphdiv"),this.specmsg=this.maindiv.find("#specmsg"),this.webspec=null,this.staticdiv=this.maindiv.find("#staticdiv"),this.dynamicdiv=this.maindiv.find("#dynamicdiv"),this.togglediv=$("#toggleinteract")},a.prototype.print=function(){console.log("We are now printing galaxy",this.plateifu,this.plate,this.ifu)},a.prototype.setPlateIfu=function(a){void 0===a?this.plateifu=$(".galinfo").attr("id"):this.plateifu=a,[this.plate,this.ifu]=this.plateifu.split("-")},a.prototype.loadSpaxel=function(a){this.webspec=new Dygraph(this.specdiv[0],a,{labels:["x","Flux"],errorBars:!0})},a.prototype.updateSpaxel=function(a,b){var c="Here's a spectrum: "+b;this.specmsg.empty(),this.specmsg.html(c),this.webspec.updateOptions({file:a})},a.prototype.initOpenLayers=function(a){this.image=a,this.olmap=new OLMap(a),this.olmap.map.on("singleclick",this.getSpaxel,this)},a.prototype.getSpaxel=function(a){var b=(a.map,a.coordinate),c=["plateifu","image","imwidth","imheight","mousecoords"],d=utils.buildForm(c,this.plateifu,this.image,this.olmap.imwidth,this.olmap.imheight,b),e=this;$.post(Flask.url_for("galaxy_page.getspaxel"),d,"json").done(function(a){$("#mouse-output").empty();var c="<h5>My mouse coords "+b+", message: "+a.result.message+"</h5>";$("#mouse-output").html(c),e.updateSpaxel(a.result.spectra,a.result.specmsg)}).fail(function(a){$("#mouse-output").empty();var b="<h5>Error message: "+a.result.message+"</h5>";$("#mouse-output").html(b)})},a.prototype.toggleInteract=function(a,b){if(this.togglediv.hasClass("active"))this.togglediv.button("reset"),this.dynamicdiv.hide(),this.staticdiv.show();else{this.togglediv.button("complete"),this.staticdiv.hide(),this.dynamicdiv.show();var c=this.specdiv.is(":empty"),d=this.mapdiv.is(":empty");void 0!==this.specdiv&&c&&this.loadSpaxel(a),d&&this.initOpenLayers(b)}},a}();var OLMap,__bind=function(a,b){return function(){return a.apply(b,arguments)}};OLMap=function(){function a(b,c){return!1==this instanceof a?new a:void this.init(b)}return marvin.OLMap=a,a.prototype.init=function(a){void 0===a?console.error("Must specify an input image to initialize a Map!"):(this.image=a,this.staticimdiv=$("#staticimage")[0],this.mapdiv=$("#map")[0],this.getImageSize(),this.setProjection(),this.setView(),this.initMap(),this.addDrawInteraction())},a.prototype.print=function(){console.log("We are now printing openlayers map")},a.prototype.getImageSize=function(){void 0!==this.staticimdiv&&(this.imwidth=this.staticimdiv.naturalWidth,this.imheight=this.staticimdiv.naturalHeight)},a.prototype.setMouseControl=function(){var a=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",undefinedHTML:"&nbsp;"});return a},a.prototype.setProjection=function(){this.extent=[0,0,this.imwidth,this.imheight],this.projection=new ol.proj.Projection({code:"ifu",units:"pixels",extent:this.extent})},a.prototype.setBaseImageLayer=function(){var a=new ol.layer.Image({source:new ol.source.ImageStatic({url:this.image,projection:this.projection,imageExtent:this.extent})});return a},a.prototype.setView=function(){this.view=new ol.View({projection:this.projection,center:ol.extent.getCenter(this.extent),zoom:0,maxZoom:8,maxResolution:1.4})},a.prototype.initMap=function(){var a=this.setMouseControl(),b=this.setBaseImageLayer();this.map=new ol.Map({controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([a]),layers:[b],target:this.mapdiv,view:this.view})},a.prototype.addDrawInteraction=function(){var a,b=new ol.source.Vector({wrapX:!1}),c=this.newVectorLayer(b);this.map.addLayer(c);var d,e,f="Point";this.draw=new ol.interaction.Draw({source:b,type:f,geometryFunction:d,maxPoints:e}),this.draw.on("drawend",function(c){a&&b.removeFeature(a),a=c.feature}),this.map.addInteraction(this.draw)},a.prototype.newVectorLayer=function(a){var b=new ol.layer.Vector({source:a,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"#ffcc33"})})})});return b},a}();var Utils,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Utils=function(){function a(){return!1==this instanceof a?new a:void this.init()}return marvin.Utils=a,a.prototype.init=function(){},a.prototype.buildForm=function(){for(var a=arguments.length,b=new Array(a),c=0;a>c;++c)b[c]=arguments[c];var d=b[0],e={};return $.each(b.slice(1),function(a,b){e[d[a]]=b}),e},a.prototype.unique=function(a){var b=[];return $.each(a,function(a,c){-1==$.inArray(c,b)&&b.push(c)}),b},a}();