"use strict";var Utils,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Utils=function(){function Utils(){return!1==this instanceof Utils?new Utils:void this.init()}return marvin.Utils=Utils,Utils.prototype.init=function(){},Utils.prototype.buildForm=function(){for(var _len=arguments.length,args=new Array(_len),$_i=0;_len>$_i;++$_i)args[$_i]=arguments[$_i];var names=args[0],form={};return $.each(args.slice(1),function(index,value){form[names[index]]=value}),form},Utils.prototype.unique=function(data){var result=[];return $.each(data,function(i,value){-1==$.inArray(value,result)&&result.push(value)}),result},Utils}();var OLMap,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};OLMap=function(){function OLMap(image,requestedOptions){return!1==this instanceof OLMap?new OLMap:void this.init(image)}return marvin.OLMap=OLMap,OLMap.prototype.init=function(image){void 0===image?console.error("Must specify an input image to initialize a Map!"):(this.image=image,this.staticimdiv=$("#staticimage")[0],this.mapdiv=$("#map")[0],this.getImageSize(),this.setProjection(),this.setView(),this.initMap(),this.addDrawInteraction())},OLMap.prototype.print=function(){console.log("We are now printing openlayers map")},OLMap.prototype.getImageSize=function(){void 0!==this.staticimdiv&&(this.imwidth=this.staticimdiv.naturalWidth,this.imheight=this.staticimdiv.naturalHeight)},OLMap.prototype.setMouseControl=function(){var mousePositionControl=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",undefinedHTML:"&nbsp;"});return mousePositionControl},OLMap.prototype.setProjection=function(){this.extent=[0,0,this.imwidth,this.imheight],this.projection=new ol.proj.Projection({code:"ifu",units:"pixels",extent:this.extent})},OLMap.prototype.setBaseImageLayer=function(){var imagelayer=new ol.layer.Image({source:new ol.source.ImageStatic({url:this.image,projection:this.projection,imageExtent:this.extent})});return imagelayer},OLMap.prototype.setView=function(){this.view=new ol.View({projection:this.projection,center:ol.extent.getCenter(this.extent),zoom:0,maxZoom:8,maxResolution:1.4})},OLMap.prototype.initMap=function(){var mousePositionControl=this.setMouseControl(),baseimage=this.setBaseImageLayer();this.map=new ol.Map({controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([mousePositionControl]),layers:[baseimage],target:this.mapdiv,view:this.view})},OLMap.prototype.addDrawInteraction=function(){var lastFeature,drawsource=new ol.source.Vector({wrapX:!1}),pointVector=this.newVectorLayer(drawsource);this.map.addLayer(pointVector);var geometryFunction,maxPoints,value="Point";this.draw=new ol.interaction.Draw({source:drawsource,type:value,geometryFunction:geometryFunction,maxPoints:maxPoints}),this.draw.on("drawend",function(e){lastFeature&&drawsource.removeFeature(lastFeature),lastFeature=e.feature}),this.map.addInteraction(this.draw)},OLMap.prototype.newVectorLayer=function(source){var vector=new ol.layer.Vector({source:source,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"#ffcc33"})})})});return vector},OLMap}();var Galaxy,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};Galaxy=function(){function Galaxy(plateifu){return!1==this instanceof Galaxy?new Galaxy:void this.init(plateifu)}return marvin.Galaxy=Galaxy,Galaxy.prototype.init=function(plateifu){this.setPlateIfu(plateifu),this.maindiv=$("#"+this.plateifu),this.mapdiv=this.maindiv.find("#map"),this.specdiv=this.maindiv.find("#graphdiv"),this.specmsg=this.maindiv.find("#specmsg"),this.webspec=null,this.staticdiv=this.maindiv.find("#staticdiv"),this.dynamicdiv=this.maindiv.find("#dynamicdiv"),this.togglediv=$("#toggleinteract")},Galaxy.prototype.print=function(){console.log("We are now printing galaxy",this.plateifu,this.plate,this.ifu)},Galaxy.prototype.setPlateIfu=function(plateifu){void 0===plateifu?this.plateifu=$(".galinfo").attr("id"):this.plateifu=plateifu,[this.plate,this.ifu]=this.plateifu.split("-")},Galaxy.prototype.loadSpaxel=function(spaxel){this.webspec=new Dygraph(this.specdiv[0],spaxel,{labels:["x","Flux"],errorBars:!0})},Galaxy.prototype.updateSpaxel=function(spaxel,specmsg){var newmsg="Here's a spectrum: "+specmsg;this.specmsg.empty(),this.specmsg.html(newmsg),this.webspec.updateOptions({file:spaxel})},Galaxy.prototype.initOpenLayers=function(image){this.image=image,this.olmap=new OLMap(image),this.olmap.map.on("singleclick",this.getSpaxel,this)},Galaxy.prototype.getSpaxel=function(event){var mousecoords=(event.map,event.coordinate),keys=["plateifu","image","imwidth","imheight","mousecoords"],form=utils.buildForm(keys,this.plateifu,this.image,this.olmap.imwidth,this.olmap.imheight,mousecoords),_this=this;$.post(Flask.url_for("galaxy_page.getspaxel"),form,"json").done(function(data){$("#mouse-output").empty();var myhtml="<h5>My mouse coords "+mousecoords+", message: "+data.result.message+"</h5>";$("#mouse-output").html(myhtml),_this.updateSpaxel(data.result.spectra,data.result.specmsg)}).fail(function(data){$("#mouse-output").empty();var myhtml="<h5>Error message: "+data.result.message+"</h5>";$("#mouse-output").html(myhtml)})},Galaxy.prototype.toggleInteract=function(spaxel,image){if(this.togglediv.hasClass("active"))this.togglediv.button("reset"),this.dynamicdiv.hide(),this.staticdiv.show();else{this.togglediv.button("complete"),this.staticdiv.hide(),this.dynamicdiv.show();var specempty=this.specdiv.is(":empty"),mapempty=this.mapdiv.is(":empty");void 0!==this.specdiv&&specempty&&this.loadSpaxel(spaxel),mapempty&&this.initOpenLayers(image)}},Galaxy}();