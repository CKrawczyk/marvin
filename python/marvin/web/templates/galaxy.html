{% extends "layout.html" %}
{% from 'macros.html' import download, panellist %}

<!-- Galaxy CSS Sources -->
{% block csshead %}
    <link rel='preconnect stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/ol3/3.14.2/ol.min.css'>
{% endblock csshead %}
<!-- Galaxy JS Sources-->
{% block jshead %}
    <script rel='preconnect' src="//cdnjs.cloudflare.com/ajax/libs/dygraph/1.1.1/dygraph-combined.js"></script>
    <script rel='preconnect' src="//cdnjs.cloudflare.com/ajax/libs/ol3/3.14.2/ol.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
{% endblock jshead %}

<!-- Single Galaxy Page -->
{% block body %}

<div class='singlegalaxy' id ='{{cube.plateifu}}'>


<div class='well' id='metadata'>
    <div class='row'>
        <div class='col-md-12 galinfo'>
            {% if not cube %}
                <h3 class='alert alert-danger'>{{error}}</h3>
            {% else %}
                <!-- Galaxy Meta Data -->
                {# Galaxy Meta Data #}
                <div class='row'>
                    <div class='col-md-3'>
                        <h4>Plate-IFU: {{cube.plateifu}}</h4>
                        <h4>Manga-ID: {{cube.mangaid}}</h4>
                        <table class='table table-condensed table-bordered table-striped marvin-metatable' id='galaxymeta'>
                            <tbody>
                                <tr><th>OBJ RA, Dec</th><td>{{cubehdr.objra}}</td><td>{{cubehdr.objdec}}</td></tr>
                                {% if not cubehdr.ifura|allclose(cubehdr.objra) %}<tr><th>IFU RA, Dec</th><td>{{cubehdr.ifura}}</td><td>{{cubehdr.ifudec}}</td></tr>{% endif %}
                                <tr><th>IFU Glon, Glat</th><td>{{cubehdr.ifuglon}}</td><td>{{cubehdr.ifuglat}}</td></tr>
                                <tr><th>SN2 Blue, Red</th><td align='center'>{{cubehdr.bluesn2|float|round(2)}}</td><td align='center'>{{cubehdr.redsn2|float|round(2)}}</td></tr>
                                <tr><th>Date Observed</th><td colspan='2' align='center'>{{cubehdr['DATE-OBS']}}</td></tr>
                                <tr><th>DAP Output</th><td colspan='2' align='center'>{{daplink|default(None)}}</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Cube Quality Flags -->
                    {# Cube Quality Flags #}
                    <div class='col-md-2 flagalert'>
                        {% set qualstatus = (quality|qaclass)[0] %}
                        {% set qualmsg = (quality|qaclass)[1] %}
                          <div class="panel panel-{{qualstatus}}" id='panel_qualityflag'>
                              <div class="panel-heading">
                                  <h3 class="panel-title">Cube Quality: {{qualmsg}}</h3>
                              </div>
                              <div class='panel-body'>
                                Bit: {{quality[1]}} <a tabindex='0' role="button" class='btn btn-{{qualstatus}} btn-xs flagpopover qualpopovers pull-right' id='qualitypopover' data-trigger='hover' data-toggle="popover" title="Quality Flags">Flags</a>
                              </div>
                          </div>
                          <div class='btn-group-vertical'>
                          {{download('#galaxydownload', links)}}
                          <a href='http://skyserver.sdss.org/dr12/en/tools/chart/navi.aspx?ra={{cubehdr.objra}}&dec={{cubehdr.objdec}}&opt=GS&scale=0.2' class='btn btn-warning' id='gotocas' target='_blank'><i class="fa fa-external-link fa-fw" aria-hidden="true"></i> Go to CAS</a>
                          </div>
                    </div>
                    <!-- MaNGA Target Flags -->
                    {# MaNGA Target Flags #}
                    <div class='col-md-2'>
                          <div class="panel panel-info" id='panel_targetflag'>
                              <div class="panel-heading">
                                  <h3 class="panel-title">MaNGA Target</h3>
                              </div>
                              <div class='panel-body'>
                                {% for bit in mngtarget.bits %}
                                <div class='row'>
                                  {% set targname = mngtarget.names[loop.index0]|lower %}
                                  <div class='col-md-12'>
                                  {{targname|targtype}} Bit: {{bit}} <a tabindex='0' role="button" class='btn btn-info btn-xs flagpopover targpopovers pull-right' id='targpopover_{{targname}}' data-trigger='hover' data-toggle="popover" title="Target Flags">Flags</a>
                                  </div>
                                </div>
                                  {{panellist('Target Flags', mngtarget.labels[loop.index0], targname)}}
                                {% endfor %}
                              </div>
                          </div>
                          <button class='btn btn-primary btn-danger' id='toggleinteract' type='button' data-toggle='button' aria-pressed="false" autocomplete='off' data-complete-text='<i class="fa fa-check fa-fw" aria-hidden="true"></i>Map/SpecView On'><i class="fa fa-close fa-fw" aria-hidden="true"></i>Map/SpecView Off</button>
                    </div>
                    {{panellist('Quality Flags', quality[2], 'drp3quality')}}
                </div>
            {% endif %}
        </div>
    </div>
</div> {# end metadata div #}


<!-- Interactive Map and Spectrum View -->
{# Map and Spectrum View #}
{% if cube %}
<div class='well' id='specview'>
    <div class='row'>
        <div class='col-md-12 galinfo'>
                <!-- static galaxy image -->
                {# Initial Static Image Display #}
                <div class='row' id='staticdiv'>
                    <div class='col-md-3'>
                        <img class='img-responsive' id='staticimage' src="{{image}}" alt="{{cube.plateifu}} Galaxy Image">
                    </div>
                </div>
                <!-- dynamic image and spaxel -->
                {# Dynamic Interaction #}
                <div id='dynamicdiv' style='display:none;'>
                    <div class='row' id='image-spec'>
                        <div class='col-md-4'>
                            <!-- <div id='imagediv' class='map' style='width:100%; height:400px;'></div> -->
                            <div id='imagediv' style='width:100%; height:400px;'></div>
                        </div>
                        <div class='col-md-8'>
                            <div id='graphdiv' style="width:100%;"></div>
                            <div class='row'>
                                <div class='col-md-5 col-md-offset-1'>
                                    {% if error %}
                                    <p class='alert alert-danger' id='specmsg_error'><strong>{{error}}</strong></p>
                                    {% else %}
                                    <p class='alert alert-danger' id='specmsg' style="display:none;"><strong>{{specmsg}}</strong></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- maps -->
                    <div class='row' id='mapsdiv'>
                        <div class='col-md-4' id='leftcol'>
                            <div id='mapdiv' class='map'></div>
                        </div>
                        <div class='col-md-4'>
                            <div id='mapdiv2' class='map'></div>
                        </div>
                        <div class='col-md-4'>
                            <div id='mapdiv3' class='map'></div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>
{% endif %}

</div> {# end of singlegalaxydiv #}

{% endblock body %}

<!-- JS Code -->
{% block code %}
<script type='text/javascript'>
    // Highcharts.theme = {chart: {backgroundColor: null}};
    // Highcharts.setOptions(Highcharts.theme);
    
    /*$(function() {
        var div = $('#mapdiv');
        var width = div.width();
        console.log('width', width);
        
        div.css('height', width);
    });*/
    //var mapwidth = $('.map').width();
    //$('.map').css({'height':mapwidth+'px'});
        
    var galaxy = {};
    $(function() {
        m.galaxy = new Galaxy();
        m.galaxy.print();
        // toggle interaction on click
        var spaxel = {{spectra|tojson}};
        var galimage = {{image|tojson}};
        var spectitle = {{specmsg|tojson}};
        var maptitle = {{'8485-1901 Halpha'|tojson}};
        var map = {{map|tojson}};
        var mapmsg = {{mapmsg|tojson}};
        var chartWidth = null;
        m.galaxy.toggleInteract(galimage, map, spaxel, maptitle, spectitle, chartWidth);
        /*$('#toggleinteract').on('click', m.galaxy, function() {
            var chartWidth = null;
            m.galaxy.toggleInteract(galimage, map, spaxel, maptitle, spectitle, chartWidth);
            chartWidth = $('#mapdiv').width();
            var chartHeight = $('#mapdiv').height();
            console.log('toggle width', $('#mapdiv').width());
            //m.galaxy.toggleInteract(galimage, map, spaxel, maptitle, spectitle, chartWidth);
            //document.getElementById('mapdiv').style.width = 400;
            window.setTimeout(function(){
                var chartWidth = $('#mapdiv').width();
                console.log('timeout', chartWidth);
                if (chartWidth) {
                    if (chartWidth > 400){
                        chartWidth = 400;
                        //chartHeight = 400;
                    } else {
                        chartHeight = chartWidth;
                    }
                    console.log('h,w', chartHeight, chartWidth);
                    $('#mapdiv').css('width', chartWidth);
                    $('#mapdiv').css('height', chartHeight);
                }
            }, 3000);
        });*/
    });
    /*$(document).ready(function(){
        window.setTimeout(function(){
            console.log("timeout delay");
            var chartWidth = $('#mpadiv').width();
            if (chartWidth > 400){
                chartWidth = 400;
            } else {
                chartHeight = chartWidth;
            }
            $('#mpadiv').css('width', chartWidth);
            $('#mpadiv').css('height', chartHeight);
        }, 10000);
    });*/
    function fixAspectRatio() {
        console.log('start fixAspectRatio w, h', $('#mapdiv').width(), $('#mapdiv').height());
        var chartWidth = $('#mapdiv').width();
        var chartHeight = $('#mapdiv').height();
        if (chartWidth > 400){
            chartWidth = 400;
            chartHeight = 400;
        } else {
            chartHeight = chartWidth;
        }
        $("#mapdiv").width(chartWidth);
        $("#mapdiv").height(chartHeight);
        console.log('end fixAspectRatio w, h', $('#mapdiv').width(), $('#mapdiv').height());
    };
    $(window).load(function() {
        fixAspectRatio();
        $('#mapdiv').hide();
        console.log($('#mapdiv').width());
        setTimeout(function() {
            $('#mapdiv').show();
        }, 0);
        console.log('on load');
    });
    $(window).resize(fixAspectRatio);
</script>
{% endblock code %}

