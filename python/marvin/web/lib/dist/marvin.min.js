/*! marvin 2016-05-11 */
"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Carousel=function(){function a(b,c){_classCallCheck(this,a),this.carouseldiv=$(b),this.thumbsdiv=void 0!==c?$(c):$("[id^=carousel-selector-]"),this.carouseldiv.carousel({interval:5e3}),this.thumbsdiv.on("click",this,this.handleThumbs),this.carouseldiv.on("slid.bs.carousel",this,this.updateText)}return _createClass(a,[{key:"print",value:function(){console.log("I am Carousel!")}},{key:"handleThumbs",value:function(a){var b=a.data,c=$(this).attr("id");try{var d=/-(\d+)$/.exec(c)[1];b.carouseldiv.carousel(parseInt(d))}catch(e){console.log("MyCarousel: Regex failed!",e)}}},{key:"updateText",value:function(a){var b=(a.data,$(".item.active").data("slide-number"));$("#carousel-text").html($("#slide-content-"+b).html())}}]),a}(),_slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Galaxy=function(){function a(b){_classCallCheck(this,a),this.setPlateIfu(b),this.maindiv=$("#"+this.plateifu),this.metadiv=this.maindiv.find("#metadata"),this.specdiv=this.maindiv.find("#specview"),this.mapdiv=this.specdiv.find("#map"),this.graphdiv=this.specdiv.find("#graphdiv"),this.specmsg=this.specdiv.find("#specmsg"),this.webspec=null,this.staticdiv=this.specdiv.find("#staticdiv"),this.dynamicdiv=this.specdiv.find("#dynamicdiv"),this.togglediv=$("#toggleinteract"),this.qualpop=$("#qualitypopover"),this.targpop=$("#targpopover"),this.initFlagPopovers()}return _createClass(a,[{key:"print",value:function(){console.log("We are now printing galaxy",this.plateifu,this.plate,this.ifu)}},{key:"setPlateIfu",value:function(a){void 0===a?this.plateifu=$(".singlegalaxy").attr("id"):this.plateifu=a;var b=this.plateifu.split("-"),c=_slicedToArray(b,2);this.plate=c[0],this.ifu=c[1]}},{key:"loadSpaxel",value:function(a){this.webspec=new Dygraph(this.graphdiv[0],a,{labels:["Wavelength","Flux"],errorBars:!0,ylabel:"Flux",xlabel:"Wavelength"})}},{key:"updateSpaxel",value:function(a,b){var c="<strong>"+b+"</strong>";this.specmsg.empty(),this.specmsg.html(c),this.webspec.updateOptions({file:a})}},{key:"initOpenLayers",value:function(a){this.image=a,this.olmap=new OLMap(a),this.olmap.map.on("singleclick",this.getSpaxel,this)}},{key:"getSpaxel",value:function(a){var b=(a.map,a.coordinate),c=["plateifu","image","imwidth","imheight","mousecoords"],d=m.utils.buildForm(c,this.plateifu,this.image,this.olmap.imwidth,this.olmap.imheight,b),e=this;$.post(Flask.url_for("galaxy_page.getspaxel"),d,"json").done(function(a){$("#mouse-output").empty();var c="<h5>My mouse coords "+b+", message: "+a.result.message+"</h5>";$("#mouse-output").html(c),e.updateSpaxel(a.result.spectra,a.result.specmsg)}).fail(function(a){$("#mouse-output").empty();var b="<h5>Error message: "+a.result.message+"</h5>";$("#mouse-output").html(b)})}},{key:"toggleInteract",value:function(a,b){if(this.togglediv.hasClass("active"))this.togglediv.toggleClass("btn-danger").toggleClass("btn-success"),this.togglediv.button("reset"),this.dynamicdiv.hide(),this.staticdiv.show();else{this.togglediv.toggleClass("btn-danger").toggleClass("btn-success"),this.togglediv.button("complete"),this.staticdiv.hide(),this.dynamicdiv.show();var c=this.graphdiv.is(":empty"),d=this.mapdiv.is(":empty");void 0!==this.graphdiv&&c&&this.loadSpaxel(a),d&&this.initOpenLayers(b)}}},{key:"initFlagPopovers",value:function(){this.qualpop.popover({html:!0,content:$("#list_drp3quality").html()}),this.targpop.popover({html:!0,content:$("#list_mngtarget").html()})}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Header=function(){function a(){_classCallCheck(this,a),this.navbar=$(".navbar"),this.galidform=$("#headform"),this.typeahead=$("#headform .typeahead"),this.mplform=$("#mplform"),this.mplselect=$("#mplselect"),this.initTypeahead(),this.mplselect.on("change",this,this.selectMPL)}return _createClass(a,[{key:"print",value:function(){console.log("I am Header!")}},{key:"initTypeahead",value:function(a,b){var a=void 0===a?this.typeahead:$(a),b=void 0===b?this.galidform:$(b);this.galids=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:Flask.url_for("index_page.getgalidlist"),remote:{url:Flask.url_for("index_page.getgalidlist"),filter:function(a){return a}}}),this.galids.initialize(),a.typeahead("destroy"),a.typeahead({showHintOnFocus:!0,source:this.galids.ttAdapter(),afterSelect:function(){b.submit()}})}},{key:"selectMPL",value:function(a){var b=a.data,c="index_page.selectmpl",d=m.utils.serializeForm("#mplform");console.log("setting new mpl",d),b.sendAjax(d,c,b.reloadPage)}},{key:"reloadPage",value:function(){location.reload(!0)}},{key:"sendAjax",value:function(a,b,c){$.post(Flask.url_for(b),a,"json").done(function(a){1==a.result.status?c():alert("Failed to set the versions! "+a.result.msg)}).fail(function(a){alert("Failed to set the versions! Problem with Flask setversion. "+a.result.msg)})}}]),a}(),Marvin=function a(b){_classCallCheck(this,a),this.options=b,this.utils=new Utils,this.utils.print(),this.header=new Header,this.header.print()},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),OLMap=function(){function a(b){_classCallCheck(this,a),void 0===b?console.error("Must specify an input image to initialize a Map!"):(this.image=b,this.staticimdiv=$("#staticimage")[0],this.mapdiv=$("#map")[0],this.getImageSize(),this.setProjection(),this.setView(),this.initMap(),this.addDrawInteraction())}return _createClass(a,[{key:"print",value:function(){console.log("We are now printing openlayers map")}},{key:"getImageSize",value:function(){void 0!==this.staticimdiv&&(this.imwidth=this.staticimdiv.naturalWidth,this.imheight=this.staticimdiv.naturalHeight)}},{key:"setMouseControl",value:function(){var a=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",undefinedHTML:"&nbsp;"});return a}},{key:"setProjection",value:function(){this.extent=[0,0,this.imwidth,this.imheight],this.projection=new ol.proj.Projection({code:"ifu",units:"pixels",extent:this.extent})}},{key:"setBaseImageLayer",value:function(){var a=new ol.layer.Image({source:new ol.source.ImageStatic({url:this.image,projection:this.projection,imageExtent:this.extent})});return a}},{key:"setView",value:function(){this.view=new ol.View({projection:this.projection,center:ol.extent.getCenter(this.extent),zoom:1,maxZoom:8,maxResolution:1.4})}},{key:"initMap",value:function(){var a=this.setMouseControl(),b=this.setBaseImageLayer();this.map=new ol.Map({controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([a]),layers:[b],target:this.mapdiv,view:this.view})}},{key:"addDrawInteraction",value:function(){var a,b=new ol.source.Vector({wrapX:!1}),c=this.newVectorLayer(b);this.map.addLayer(c);var d,e,f="Point";this.draw=new ol.interaction.Draw({source:b,type:f,geometryFunction:d,maxPoints:e}),this.draw.on("drawend",function(c){a&&b.removeFeature(a),a=c.feature}),this.map.addInteraction(this.draw)}},{key:"newVectorLayer",value:function(a){var b=new ol.layer.Vector({source:a,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#FF0808",width:2}),image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"#FF0808"})})})});return b}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Table=function(){function a(b){_classCallCheck(this,a),this.setTable(b)}return _createClass(a,[{key:"print",value:function(){console.log("I am Table!")}},{key:"setTable",value:function(a){void 0!==a&&(console.log("setting the table"),this.table=a)}},{key:"initTable",value:function(a,b){if(this.url=a,null!==b.columns)var c=this.makeColumns(b.columns);this.table.bootstrapTable({classes:"table table-bordered table-condensed table-hover",toggle:"table",pagination:!0,pageSize:10,pageList:"[10, 20, 50]",sidePagination:"server",method:"post",contentType:"application/x-www-form-urlencoded",data:b.rows,columns:c,url:a,search:!0,showColumns:!0,showToggle:!0,sortName:"cube.mangaid",sortOrder:"asc",formatNoMatches:function(){return"This table is empty..."}})}},{key:"makeColumns",value:function(a){var b=[];return a.forEach(function(a,c){var d={};d.field=a,d.title=a,d.sortable=!0,b.push(d)}),b}},{key:"handleResponse",value:function(a){null===this.table&&this.setTable(),this.table=$("#table");var b=a.columns,b=[];return a.columns.forEach(function(a,c){var d={};d.field=a,d.title=a,d.sortable=!0,b.push(d)}),this.table.bootstrapTable("refreshOptions",{columns:b}),a}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Utils=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"print",value:function(){console.log("I am Utils!")}},{key:"buildForm",value:function(a){var b=Array.prototype.slice.call(arguments,1),c={};return a.forEach(function(a,d){c[a]=b[d]}),c}},{key:"serializeForm",value:function(a){var b=$(a).serializeArray();return b}},{key:"unique",value:function(a){return new Set(a)}},{key:"scrollTo",value:function(a){if(void 0!==a){var b=$(a);$("html,body").animate({scrollTop:b.offset().top},1500,"easeInOutExpo")}else $("html,body").animate({scrollTop:0},1500,"easeInOutExpo")}},{key:"initPopOvers",value:function(){$('[data-toggle="popover"]').popover()}}]),a}();