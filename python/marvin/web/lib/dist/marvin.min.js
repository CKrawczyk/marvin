/*! marvin 2016-09-09 */
"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Carousel=function(){function a(b,c){_classCallCheck(this,a),this.carouseldiv=$(b),this.thumbsdiv=void 0!==c?$(c):$("[id^=carousel-selector-]"),this.carouseldiv.carousel({interval:5e3}),this.thumbsdiv.on("click",this,this.handleThumbs),this.carouseldiv.on("slid.bs.carousel",this,this.updateText)}return _createClass(a,[{key:"print",value:function(){console.log("I am Carousel!")}},{key:"handleThumbs",value:function(a){var b=a.data,c=$(this).attr("id");try{var d=/-(\d+)$/.exec(c)[1];b.carouseldiv.carousel(parseInt(d))}catch(e){console.log("MyCarousel: Regex failed!",e)}}},{key:"updateText",value:function(a){var b=(a.data,$(".item.active").data("slide-number"));$("#carousel-text").html($("#slide-content-"+b).html())}}]),a}(),_slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Galaxy=function(){function a(b){_classCallCheck(this,a),this.setPlateIfu(b),this.maindiv=$("#"+this.plateifu),this.metadiv=this.maindiv.find("#metadata"),this.specdiv=this.maindiv.find("#specview"),this.imagediv=this.specdiv.find("#imagediv"),this.mapsdiv=this.specdiv.find("#mapsdiv"),this.mapdiv=this.specdiv.find("#mapdiv1"),this.graphdiv=this.specdiv.find("#graphdiv"),this.specmsg=this.specdiv.find("#specmsg"),this.webspec=null,this.staticdiv=this.specdiv.find("#staticdiv"),this.dynamicdiv=this.specdiv.find("#dynamicdiv"),this.togglediv=$("#toggleinteract"),this.qualpop=$("#qualitypopover"),this.targpops=$(".targpopovers"),this.initFlagPopovers()}return _createClass(a,[{key:"print",value:function(){console.log("We are now printing galaxy",this.plateifu,this.plate,this.ifu)}},{key:"setPlateIfu",value:function(a){void 0===a?this.plateifu=$(".singlegalaxy").attr("id"):this.plateifu=a;var b=this.plateifu.split("-"),c=_slicedToArray(b,2);this.plate=c[0],this.ifu=c[1]}},{key:"loadSpaxel",value:function(a,b){this.webspec=new Dygraph(this.graphdiv[0],a,{title:b,labels:["Wavelength","Flux"],errorBars:!0,ylabel:"Flux [10<sup>-17</sup> erg/cm<sup>2</sup>/s/Å]",xlabel:"Wavelength [Ångströms]"})}},{key:"updateSpecMsg",value:function(a,b){this.specmsg.hide(),void 0!==b&&b===-1&&this.specmsg.show();var c="<strong>"+a+"</strong>";this.specmsg.empty(),this.specmsg.html(c)}},{key:"updateSpaxel",value:function(a,b){this.updateSpecMsg(b),this.webspec.updateOptions({file:a,title:b})}},{key:"initOpenLayers",value:function(a){this.image=a,this.olmap=new OLMap(a),this.olmap.map.on("singleclick",this.getSpaxel,this)}},{key:"initHeatmap",value:function(a){console.log("initHeatmap",this.mapsdiv);var b=this.mapsdiv.children("div"),c=this;$.each(b,function(b,d){var e=$(d).find("div").first();this.heatmap=new HeatMap(e,a[b].data,a[b].msg,c)})}},{key:"getSpaxel",value:function(a){var b=void 0===a.coordinate?null:a.coordinate,c=$(a.target).parents("div").first().attr("id"),d=void 0!==c&&c.search("highcharts")!==-1?"heatmap":"optical",e=void 0===a.point?null:a.point.x,f=void 0===a.point?null:a.point.y,g=["plateifu","image","imwidth","imheight","mousecoords","type","x","y"],h=m.utils.buildForm(g,this.plateifu,this.image,this.olmap.imwidth,this.olmap.imheight,b,d,e,f),i=this;$.post(Flask.url_for("galaxy_page.getspaxel"),h,"json").done(function(a){a.result.status!==-1?i.updateSpaxel(a.result.spectra,a.result.specmsg):i.updateSpecMsg("Error: "+a.result.specmsg,a.result.status)}).fail(function(a){i.updateSpecMsg("Error: "+a.result.specmsg,a.result.status)})}},{key:"toggleInteract",value:function(a,b,c,d){if(this.togglediv.hasClass("active"))this.togglediv.toggleClass("btn-danger").toggleClass("btn-success"),this.togglediv.button("reset"),this.dynamicdiv.hide(),this.staticdiv.show();else{this.togglediv.toggleClass("btn-danger").toggleClass("btn-success"),this.togglediv.button("complete"),this.staticdiv.hide(),this.dynamicdiv.show();var e=this.graphdiv.is(":empty"),f=this.imagediv.is(":empty"),g=this.mapdiv.is(":empty");void 0!==this.graphdiv&&e&&this.loadSpaxel(c,d),f&&this.initOpenLayers(a),g&&this.initHeatmap(b)}}},{key:"initFlagPopovers",value:function(){this.qualpop.popover({html:!0,content:$("#list_drp3quality").html()}),$.each(this.targpops,function(a,b){var c=b.id,d=c.split("_"),e=_slicedToArray(d,2),f=(e[0],e[1]),g="#list_"+f;$("#"+c).popover({html:!0,content:$(g).html()})})}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Header=function(){function a(){_classCallCheck(this,a),this.navbar=$(".navbar"),this.galidform=$("#headform"),this.typeahead=$("#headform .typeahead"),this.mplform=$("#mplform"),this.mplselect=$("#mplselect"),this.initTypeahead(),this.mplselect.on("change",this,this.selectMPL)}return _createClass(a,[{key:"print",value:function(){console.log("I am Header!")}},{key:"initTypeahead",value:function(a,b,c,d){var a=void 0===a?this.typeahead:$(a),b=void 0===b?this.galidform:$(b),e=void 0===c?Flask.url_for("index_page.getgalidlist"):c;this.galids=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:e,remote:{url:e,filter:function(a){return a}}}),this.galids.initialize(),a.typeahead("destroy"),a.typeahead({showHintOnFocus:!0,source:this.galids.ttAdapter(),afterSelect:function(){b.submit()}})}},{key:"selectMPL",value:function(a){var b=a.data,c="index_page.selectmpl",d=m.utils.serializeForm("#mplform");console.log("setting new mpl",d),b.sendAjax(d,c,b.reloadPage)}},{key:"reloadPage",value:function(){location.reload(!0)}},{key:"sendAjax",value:function(a,b,c){$.post(Flask.url_for(b),a,"json").done(function(a){1==a.result.status?c():alert("Failed to set the versions! "+a.result.msg)}).fail(function(a){alert("Failed to set the versions! Problem with Flask setversion. "+a.result.msg)})}}]),a}(),_slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),HeatMap=function(){function a(b,c,d,e){_classCallCheck(this,a),void 0===c?console.error("Must specify input map data to initialize a HeatMap!"):void 0===b?console.error("Must specify an input mapdiv to initialize a HeatMap"):(this.mapdiv=b,this.data=c,this.title=d,this.galthis=e,this.parseTitle(),this.initMap())}return _createClass(a,[{key:"print",value:function(){console.log("We are now printing heatmap for ",this.title)}},{key:"parseTitle",value:function(){var a=this.title.split(":"),b=_slicedToArray(a,2),c=(b[0],b[1]),d=c.split("_"),e=_slicedToArray(d,3);this.category=e[0],this.parameter=e[1],this.channel=e[2]}},{key:"getRange",value:function(a){var a=void 0===a?0:a,b=this.data.map(function(b){return b[a]});return b}},{key:"getMinMax",value:function(a){var a=void 0===a?this.getRange():a,b=Math.min.apply(null,a),c=Math.max.apply(null,a);return[b,c]}},{key:"interpColors",value:function(a){for(var b=a[1]-a[0],c=(a[0]+a[1])/2,d=chroma.scale(),e=function(a){var e=(a[2]-c)/b+.5,f=d(e),g=chroma(f).hex(),h=[{x:a[0],y:a[1],value:a[2],color:g}];return h},f=new Array,g=0;g<this.data.length;g++)f.push(e(this.data[g]));return f}},{key:"addNull",value:function(a){var b=a.map(function(a){return a[2]<.01&&(a[2]=null),a});return b}},{key:"colorNoData",value:function(a){a.wrap(a.ColorAxis.prototype,"toColor",function(a,b,c){return b<5?"#FF00FF":a.apply(this,Array.prototype.slice.call(arguments,1))})}},{key:"initMap",value:function(){var a,b,c,d,e=this.galthis,f=this.getRange(0),g=this.getRange(2),h=this.getMinMax(f),i=_slicedToArray(h,2);a=i[0],b=i[1];var j=this.getMinMax(g),k=_slicedToArray(j,2);c=k[0],d=k[1];var l=this.addNull(this.data);console.log("AFTER data",l),this.mapdiv.highcharts({chart:{type:"heatmap",marginTop:40,marginBottom:80,plotBorderWidth:1},credits:{enabled:!1},title:{text:this.title},navigation:{buttonOptions:{theme:{fill:null}}},xAxis:{title:{text:"Spaxel X"},minorGridLineWidth:0,min:a,max:b,tickInterval:1},yAxis:{title:{text:"Spaxel Y"},min:a,max:b,tickInterval:1,endontick:!1},colorAxis:{min:Math.floor(c),max:Math.ceil(d),minColor:"#00BFFF",maxColor:"#000080",labels:{align:"right"},reversed:!1},plotOptions:{heatmap:{nullColor:"#FF00FF"}},legend:{align:"right",layout:"vertical",verticalAlign:"middle",title:{text:this.parameter}},tooltip:{formatter:function(){return"<br>("+this.point.x+", "+this.point.y+"): <b>"+this.point.value+"</b><br>"}},series:[{type:"heatmap",name:"halphas",data:l,dataLabels:{enabled:!1},events:{click:function(a){e.getSpaxel(a)}}}]})}}]),a}(),Marvin=function a(b){_classCallCheck(this,a),this.options=b,this.utils=new Utils,this.utils.print(),this.utils.initToolTips(),this.header=new Header,this.header.print()},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),OLMap=function(){function a(b){_classCallCheck(this,a),void 0===b?console.error("Must specify an input image to initialize a Map!"):(this.image=b,this.staticimdiv=$("#staticimage")[0],this.mapdiv=$("#imagediv")[0],this.getImageSize(),this.setProjection(),this.setView(),this.initMap(),this.addDrawInteraction())}return _createClass(a,[{key:"print",value:function(){console.log("We are now printing openlayers map")}},{key:"getImageSize",value:function(){void 0!==this.staticimdiv&&(this.imwidth=this.staticimdiv.naturalWidth,this.imheight=this.staticimdiv.naturalHeight)}},{key:"setMouseControl",value:function(){var a=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",undefinedHTML:"&nbsp;"});return a}},{key:"setProjection",value:function(){this.extent=[0,0,this.imwidth,this.imheight],this.projection=new ol.proj.Projection({code:"ifu",units:"pixels",extent:this.extent})}},{key:"setBaseImageLayer",value:function(){var a=new ol.layer.Image({source:new ol.source.ImageStatic({url:this.image,projection:this.projection,imageExtent:this.extent})});return a}},{key:"setView",value:function(){this.view=new ol.View({projection:this.projection,center:ol.extent.getCenter(this.extent),zoom:1,maxZoom:8,maxResolution:1.4})}},{key:"initMap",value:function(){var a=this.setMouseControl(),b=this.setBaseImageLayer();this.map=new ol.Map({controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([a]),layers:[b],target:this.mapdiv,view:this.view})}},{key:"addDrawInteraction",value:function(){var a,b=new ol.source.Vector({wrapX:!1}),c=this.newVectorLayer(b);this.map.addLayer(c);var d,e,f="Point";this.draw=new ol.interaction.Draw({source:b,type:f,geometryFunction:d,maxPoints:e}),this.draw.on("drawend",function(c){a&&b.removeFeature(a),a=c.feature}),this.map.addInteraction(this.draw)}},{key:"newVectorLayer",value:function(a){var b=new ol.layer.Vector({source:a,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#FF0808",width:2}),image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"#FF0808"})})})});return b}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Search=function(){function a(){_classCallCheck(this,a),this.searchform=$("#searchform"),this.typeahead=$("#searchform .typeahead"),this.returnparams=$("#returnparams"),this.parambox=$("#parambox"),this.searchbox=$("#searchbox")}return _createClass(a,[{key:"print",value:function(){console.log("I am Search!")}},{key:"extractor",value:function(a){var b=new RegExp("([^,]+)$"),c=b.exec(a);return c&&c[1]?c[1].trim():""}},{key:"initTypeahead",value:function(a,b,c,d){function e(a){var b=a.toString();return[f.extractor(b)]}var f=this,a=void 0===a?this.typeahead:$(a),b=void 0===b?this.searchform:$(b),g=void 0===c?Flask.url_for("search_page.getparams"):c;this.queryparams=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:e,prefetch:g,remote:{url:g,filter:function(a){return a}}}),this.queryparams.initialize(),a.typeahead("destroy"),a.typeahead({showHintOnFocus:!0,source:this.queryparams.ttAdapter(),updater:function(a){var b=this.$element.val(),c=b.replace(/[^,]*$/,""),d=c+a+", ";return d},matcher:function(a){var b=f.extractor(this.query);return!!b&&~a.toLowerCase().indexOf(b.toLowerCase())},highlighter:function(a){var b=f.extractor(this.query),c=b.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");return a.replace(new RegExp("("+c+")","ig"),function(a,b){return"<strong>"+b+"</strong>"})}})}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Table=function(){function a(b){_classCallCheck(this,a),this.setTable(b)}return _createClass(a,[{key:"print",value:function(){console.log("I am Table!")}},{key:"setTable",value:function(a){void 0!==a&&(console.log("setting the table"),this.table=a)}},{key:"initTable",value:function(a,b){if(this.url=a,null!==b.columns)var c=this.makeColumns(b.columns);this.table.bootstrapTable({classes:"table table-bordered table-condensed table-hover",toggle:"table",pagination:!0,pageSize:10,pageList:"[10, 20, 50]",sidePagination:"server",method:"post",contentType:"application/x-www-form-urlencoded",data:b.rows,columns:c,url:a,search:!0,showColumns:!0,showToggle:!0,sortName:"cube.mangaid",sortOrder:"asc",formatNoMatches:function(){return"This table is empty..."}})}},{key:"makeColumns",value:function(a){var b=[];return a.forEach(function(a,c){var d={};d.field=a,d.title=a,d.sortable=!0,b.push(d)}),b}},{key:"handleResponse",value:function(a){null===this.table&&this.setTable(),this.table=$("#table");var b=a.columns,b=[];return a.columns.forEach(function(a,c){var d={};d.field=a,d.title=a,d.sortable=!0,b.push(d)}),this.table.bootstrapTable("refreshOptions",{columns:b}),a}}]),a}(),_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Utils=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"print",value:function(){console.log("I am Utils!")}},{key:"buildForm",value:function(a){var b=Array.prototype.slice.call(arguments,1),c={};return a.forEach(function(a,d){c[a]=b[d]}),c}},{key:"serializeForm",value:function(a){var b=$(a).serializeArray();return b}},{key:"unique",value:function(a){return new Set(a)}},{key:"scrollTo",value:function(a){if(void 0!==a){var b=$(a);$("html,body").animate({scrollTop:b.offset().top},1500,"easeInOutExpo")}else $("html,body").animate({scrollTop:0},1500,"easeInOutExpo")}},{key:"initPopOvers",value:function(){$('[data-toggle="popover"]').popover()}},{key:"initToolTips",value:function(){$('[data-toggle="tooltip"]').tooltip()}}]),a}();